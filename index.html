<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Document</title>
    <style>
        canvas {
            display: block;
            width: 100%;
            height: 100vh;
            cursor: grab;
        }
    </style>
</head>
<body>
    <audio id="myAudio" autoplay loop>
        <source src="hualiansong.mp3" type="audio/mpeg">
    </audio>
    <!-- 
        https://github.com/mrdoob/three.js/releases/tag/r151
        r151 feat. multi uvs - https://github.com/mrdoob/three.js/pull/25721
    -->
    <script async src="https://ga.jspm.io/npm:es-module-shims@1.5.1/dist/es-module-shims.js"
        crossorigin="anonymous"></script>
    <script type="importmap">
        {
            "imports": {
                "three": "https://unpkg.com/three@0.151.0/build/three.module.js",
                "three/addons/": "https://unpkg.com/three@0.151.0/examples/jsm/",
                "postprocessing": "https://unpkg.com/postprocessing@6.30.1/build/postprocessing.esm.js"
            }
        }
    </script>

    <script type="module">
        import * as THREE from 'three'
        import { OrbitControls } from 'three/addons/controls/OrbitControls.js'
        import { RenderPass, EffectPass, EffectComposer, GodRaysEffect } from 'postprocessing'

        // Max Muselmann https://unsplash.com/photos/oIVvGqqwVJw
        const image_url = 'hualian.jpg'
        const image_ratio = 687 / 1031
        const image_tex = new THREE.TextureLoader().load(image_url)
        image_tex.repeat.set(1, 1)

        // Daniil Silantev https://unsplash.com/photos/dxGTQArsC3M
        const alpha_url = 'https://images.unsplash.com/photo-1510942752400-ebce99a8a2c0?ixlib=rb-4.0.3&ixid=MnwxMjA3fDB8MHxzZWFyY2h8MzN8fHRyaWFuZ2xlfGVufDB8fDB8fA%3D%3D&auto=format&fit=crop&w=600&q=60'
        const alpha_tex = new THREE.TextureLoader().load(alpha_url)
        alpha_tex.repeat.set(0.6, 2)
        alpha_tex.offset.x = (1 - alpha_tex.repeat.x) / 2
        alpha_tex.wrapT = THREE.RepeatWrapping

        // ----
        // main
        // ----

        const renderer = new THREE.WebGLRenderer()
        const scene = new THREE.Scene()
        const camera = new THREE.PerspectiveCamera(75, 2, 0.1, 100)
        const controls = new OrbitControls(camera, renderer.domElement)

        camera.position.set(0, 0, 1)
        controls.enableDamping = true

        const light = new THREE.DirectionalLight()
        light.position.set(0, 0, 1)
        scene.add(light)

        const geom = new THREE.PlaneGeometry(image_ratio * 2, 2)
        const mat = new THREE.MeshLambertMaterial({ alphaMap: alpha_tex, alphaTest: 0.15, map: image_tex })
        const mesh = new THREE.Mesh(geom, mat)
        scene.add(mesh)

        const wall = new THREE.Mesh(geom, new THREE.MeshBasicMaterial({ alphaMap: alpha_tex, alphaTest: 0.15, map: image_tex }))
        wall.scale.setScalar(1.2)
        wall.position.z = -0.1
        scene.add(wall)

        // ----
        // render
        // ----

        const composer = new EffectComposer(renderer)
        const renderPass = new RenderPass(scene, camera)
        const effect = new GodRaysEffect(camera, wall, { density: 1, decay: 0.96, weight: 1 })
        const effectPass = new EffectPass(camera, effect)
        composer.addPass(renderPass)
        composer.addPass(effectPass)

        renderer.setAnimationLoop((t) => {
            composer.render()
            controls.update()
            alpha_tex.offset.y = t * -0.001
        })

        // ----
        // view
        // ----

        function resize(w, h, dpr = devicePixelRatio) {
            renderer.setPixelRatio(dpr)
            // renderer.setSize(w, h, false)
            composer.setSize(w, h, false)
            camera.aspect = w / h
            camera.updateProjectionMatrix()
        }
        addEventListener('resize', () => resize(innerWidth, innerHeight))
        dispatchEvent(new Event('resize'))
        document.body.prepend(renderer.domElement)

        document.addEventListener('DOMContentLoaded', function () {
        var audio = document.getElementById('myAudio');
        // Play the audio when the user clicks anywhere on the page
        document.addEventListener('click', function() {
            audio.play();
        }, { once: true }); // Add { once: true } to ensure the event listener triggers only once
    });
    </script>
</body>
</html>